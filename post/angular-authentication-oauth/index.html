<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    


    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="Let&#39;s code: Authentication in Angular #2 - Auth service"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@benetisz"/>



  	<meta property="og:title" content="Let&#39;s code: Authentication in Angular #2 - Auth service &middot; Typical personal blog" />
  	<meta property="og:site_name" content="Typical personal blog" />
  	<meta property="og:url" content="https://benetis.me/post/angular-authentication-oauth/" />
    
    
        
            <meta property="og:image" content="https://benetis.me/images/blog_cover_optimized_stars.jpg"/>
        
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="og:image" content="https://benetis.me/" />
    <meta property="article:published_time" content="2017-05-10T23:00:24&#43;02:00" />

    
    <meta property="article:tag" content="Angular" />
    
    <meta property="article:tag" content="Frontend" />
    
    <meta property="article:tag" content="Side-project" />
    
    <meta property="article:tag" content="Let&#39;s code" />
    
    <meta property="article:tag" content="ngrx" />
    
    

    <title>Let&#39;s code: Authentication in Angular #2 - Auth service &middot; Typical personal blog</title>

    
    <meta name="description" content="" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://benetis.me/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://benetis.me/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://benetis.me/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://benetis.me/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />

    

    
      
          <link href="https://benetis.me/index.xml" rel="alternate" type="application/rss+xml" title="Typical personal blog" />
      
      
    
    <meta name="generator" content="Hugo 0.19-DEV" />

    <link rel="canonical" href="https://benetis.me/post/angular-authentication-oauth/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": ""
    },
    "author": {
        "@type": "Person",
        "name": "",
        
        "url": "https://benetis.me",
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": "Let's code: Authentication in Angular #2 - Auth service",
    "name": "Let's code: Authentication in Angular #2 - Auth service",
    "wordCount":  1357 ,
    "timeRequired": "PT7M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "https://benetis.me/post/angular-authentication-oauth/",
    "datePublished": "2017-05-10T23:00Z",
    "dateModified": "2017-05-10T23:00Z",
    
    "keywords": "Angular, Frontend, Side-project, Let's code, ngrx",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://benetis.me/post/angular-authentication-oauth/"
    }
}
    </script>
    


    

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-36419336-4', 'auto');
      ga('send', 'pageview');

    </script>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.6.0/themes/prism.min.css" />

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="https://benetis.me/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
  
      <a class="menu-button icon-feed" href="https://benetis.me/index.xml">&nbsp;&nbsp;Subscribe</a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Let&#39;s code: Authentication in Angular #2 - Auth service</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2017-05-10T23:00:24&#43;02:00">
            May 10, 2017
          </time>
        
         
          <span class="post-tag small"><a href="https://benetis.me/tags/angular/">#Angular</a></span>
         
          <span class="post-tag small"><a href="https://benetis.me/tags/frontend/">#Frontend</a></span>
         
          <span class="post-tag small"><a href="https://benetis.me/tags/side-project/">#Side-project</a></span>
         
          <span class="post-tag small"><a href="https://benetis.me/tags/lets-code/">#Let&#39;s code</a></span>
         
          <span class="post-tag small"><a href="https://benetis.me/tags/ngrx/">#ngrx</a></span>
         
        </section>
    </header>

    <section class="post-content">
      

<h3 id="introduction">Introduction</h3>

<p>This is part two of <strong>Authentication in Angular</strong> series. This one is about building authentication part to handle OAuth calls for us. You can find first post here: <a href="https://benetis.me/post/angular-authentication/">https://benetis.me/post/angular-authentication/</a></p>

<p>We will be using redux with our angular project to help us handle side effects. <a href="https://github.com/ngrx/store">https://github.com/ngrx/store</a></p>

<p>Our setup - angular-cli 1.0 + Angular4 (Angular 4.1)</p>

<h3 id="aims">Aims</h3>

<ul>
<li>After user clicks login - we need to call OAuth endpoint to get <code>access</code> and <code>refresh</code> tokens which we will store in local storage</li>
<li>Show errors for user</li>
<li>We want to store tokens in our redux store so they are easily accessible and can be added as headers to our api requests</li>
</ul>

<h3 id="login">Login</h3>

<p>Ah, the login. Grabbing the access token with your username and password.</p>

<h4 id="security-concerns">Security concerns</h4>

<p>We are going to save that token in local storage. Although for security purposes it should end up in cookies with <code>httpOnly</code> and <code>secure</code> flags. It is all because of XSS. If javascript can access token - attacker can do that also. Read more here - <a href="https://auth0.com/blog/cookies-vs-tokens-definitive-guide/">https://auth0.com/blog/cookies-vs-tokens-definitive-guide/</a></p>

<h4 id="ngrx">Ngrx</h4>

<p>Creating folder named <code>classes</code> under <code>app/</code> to hold <code>auth.reducer, auth.effects and auth.actions</code>. I keep reducers and actions close to the module they belong too, although effects need to be imported in root module.</p>

<p>We will need two actions for login. One will be dispatched when user clicks login and another after we get response from server.</p>

<pre><code class="language-typescript">LOGIN: type('[Auth] Login'),
LOGIN_COMPLETE: type('[Auth] Login complete'),
</code></pre>

<p>Just a basic skeleton for now, no business logic. We will come back in a sec.</p>

<h4 id="login-events">Login events</h4>

<p>Upon clicking login we will dispatch event and show response to the user. If error - we will display error message from response. (<code>either invalid username/password</code> or <code>too many attempts</code>)</p>

<p>So from last blog we have this <code>login-form.component</code>. Let&rsquo;s update!</p>

<p>I like to start from models. First let&rsquo;s create interface of &ldquo;LoginUser&rdquo; and call it exactly that.</p>

<blockquote>
<p>Do not try to generalize User interface here. It will be hard to manage optional parameters. Just create few. Don&rsquo;t be afraid to have <code>LoginUser</code>, <code>RegisterUser</code> and <code>ProfileUser</code> interfaces.</p>
</blockquote>

<pre><code class="language-typescript">export interface LoginUser {
  email: string,
  password: string,
  grant_type: 'password', //We set type to password since its not going to change
  client_id: 1 //Same with client_id - it is not going to change. Prevent mistakes at compile time :^)
}
</code></pre>

<p>Next add variable to hold our login form variable state (info we will submit later)</p>

<pre><code class="language-typescript">public user: LoginUser = {email: '', password: '', client_id: 1, grant_type: 'password'}
</code></pre>

<p><code>onSubmit</code> function which is called when user clicks <code>Login</code>. As said previously - it dispatches event to login which we will handle later.</p>

<pre><code class="language-typescript">public onSubmit() {
  this.store.dispatch(new auth.LoginAction({...this.user}))
}
</code></pre>

<h3 id="auth-client-part">Auth client part</h3>

<p>We have <code>api-client</code> which handle all api requests to backend and we could add auth routes to it also. Instead - we will create new service just for auth. Reason being - OAuth2 which we are implementing has different responses from our usual api responses (following spec) and we want to isolate them</p>

<p>p.s similar example of what api-client is: <a href="https://github.com/ESNLithuania/boarded/blob/master/src/app/services/request.service.ts">https://github.com/ESNLithuania/boarded/blob/master/src/app/services/request.service.ts</a></p>

<p>Basically a service where we wrap our requests to manage them easier.</p>

<p><code>auth-client.ts</code></p>

<pre><code class="language-typescript">public oauth(): { login: (LoginUser) =&gt; Observable&lt;Response&gt; } {
  return {
    login: (loginUser) =&gt; {
      return this
        .post(`oauth/access_token`, loginUser)
    }
  }
}
</code></pre>

<p>Also it&rsquo;s important to note that since responses are different - we need to handle errors differently. We grab error description from json response and just leave it for effect to handle.</p>

<p>Handle error function taken from - <a href="https://angular.io/docs/ts/latest/guide/server-communication.html#!#error-handling">https://angular.io/docs/ts/latest/guide/server-communication.html#!#error-handling</a></p>

<pre><code class="language-typescript">private post(url: string
  , objToPost: any): Observable&lt;Response&gt; {

  const headers = new Headers({'Content-Type': 'application/json'});
  const options = new RequestOptions({headers: headers});

  return this.http
    .post(this.url + url, objToPost, options)
    .map(this.extractData)
    .catch(this.handleError)
}

private extractData(res: Response) {
  const body = res.json();
  return body || {};
}

private handleError(error: Response | any) {
  const errMsg = error.json().error_description
  return Observable.throw(errMsg);
}

</code></pre>

<p>And our effect for doing login looks like this:</p>

<pre><code class="language-typescript">
constructor(private actions$: Actions
   , private authClient: AuthClientService) {
 }

 @Effect()
 loginUser$: Observable&lt;Action&gt; = this.actions$
   .ofType(auth.ActionTypes.LOGIN)
   .map(toPayload)
   .switchMap((payload: LoginUser) =&gt; {
     return this
       .authClient
       .oauth()
       .login(payload)
       .map(res =&gt; new auth.LoginCompleteAction())
       .catch(err =&gt; of(new auth.LoginCompleteAction(err)))
   });

</code></pre>

<p>We should get access token now after doing request in login form.</p>

<h3 id="handling-login-response">Handling login response</h3>

<p>Things to do with response:</p>

<ul>
<li>Error -&gt; Show error in login form</li>
<li>Indicate that request is happening</li>
<li>Successful -&gt; Put token in LocalStorage &amp; Redirect</li>
</ul>

<h4 id="error-handling">Error handling</h4>

<p>For errors we can create another action: <code>LoginCompleteErrorAction</code> to pass error response to reducer and subscribe to error messages for login form.</p>

<pre><code class="language-typescript">export class LoginCompleteErrorAction implements Action {
  type = ActionTypes.LOGIN_COMPLETE_WITH_ERROR;

  constructor(public payload: string) {
  }
}
</code></pre>

<p>In our <code>auth.reducer</code> we will add few variables in state.</p>

<pre><code class="language-typescript">import * as login from './auth.actions';

export interface State {
  loginErrMsg: string;
  loginResponseAwaiting: boolean;
  loginSuccessful: boolean;
}

export const initialState: State = {
  loginErrMsg: '',
  loginResponseAwaiting: false,
  loginSuccessful: false
};

export function reducer(state = initialState,
                        action: login.Actions): State {

  switch (action.type) {
    case login.ActionTypes.LOGIN: {
      return {
        ...state,
        loginResponseAwaiting: true
      }
    }
    case login.ActionTypes.LOGIN_COMPLETE_WITH_ERROR: {
      return {
        ...state,
        loginErrMsg: &lt;string&gt;action.payload,
        loginResponseAwaiting: false
      };
    }
    case login.ActionTypes.LOGIN_COMPLETE: {
      return {
        ...state,
        loginResponseAwaiting: false,
        loginSuccessful: true,
        loginErrMsg: ''
      };
    }
    default: {
      return state;
    }
  }
}

export const getLoginErrMsg = (state: State) =&gt; state.loginErrMsg
export const getLoginResponseAwaiting = (state: State) =&gt; state.loginResponseAwaiting
export const getLoginSuccessful = (state: State) =&gt; state.loginSuccessful
</code></pre>

<p><code>login-form.component.html</code></p>

<pre><code class="language-html">&lt;form *ngIf=&quot;!(loginResponseAwaiting$ | async)&quot;
      fxLayout=&quot;column&quot;
      #loginForm=&quot;ngForm&quot;
      (ngSubmit)=&quot;onSubmit()&quot;
&gt;
    &lt;anv-alert [active]=&quot;errMsg.length &gt; 0&quot;&gt;{{errMsg}}&lt;/anv-alert&gt;
    &lt;md-input-container fxFlex=&quot;100&quot;&gt;
        &lt;input mdInput
               name=&quot;email&quot;
               type=&quot;email&quot;
               [(ngModel)]=&quot;user.username&quot;
               required
               validEmail
               placeholder=&quot;Email&quot;&gt;
        &lt;md-error&gt;Email is invalid&lt;/md-error&gt;
    &lt;/md-input-container&gt;
    &lt;md-input-container fxFlex=&quot;100&quot;&gt;
        &lt;input mdInput
               name=&quot;password&quot;
               type=&quot;password&quot;
               [(ngModel)]=&quot;user.password&quot;
               required
               placeholder=&quot;Password&quot;&gt;
        &lt;md-error&gt;Needs to be at least 8 characters&lt;/md-error&gt;
    &lt;/md-input-container&gt;
    &lt;div fxFlex=&quot;33&quot;
         fxFlexAlign=&quot;end&quot;&gt;
        &lt;button md-raised-button
                type=&quot;submit&quot;
                [disabled]=&quot;!loginForm.valid&quot;
        &gt;Login
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
&lt;div *ngIf=&quot;loginResponseAwaiting$ | async&quot;
     fxLayoutAlign=&quot;center center&quot;&gt;
    &lt;md-spinner mode=&quot;indeterminate&quot;&gt;&lt;/md-spinner&gt;
&lt;/div&gt;
</code></pre>

<p><code>login-form.component</code></p>

<pre><code class="language-typescript">@Component({
  selector: 'anv-login-form',
  templateUrl: './login-form.component.html',
  styleUrls: ['./login-form.component.scss']
})
export class LoginFormComponent implements OnInit, OnDestroy {

  public user: LoginUser = {username: '', password: '', client_id: 1, grant_type: 'password'}

  public errMsg$: Observable&lt;string&gt;;
  public errMsg: string = '';
  public loginResponseAwaiting$: Observable&lt;boolean&gt;;
  public loginSuccessful$: Observable&lt;boolean&gt;;

  private sub: any;

  constructor(private store: Store&lt;fromRoot.State&gt;) {
    this.loginResponseAwaiting$ = store.select(fromRoot.getLoginResponseAwaiting)
    this.errMsg$ = store.select(fromRoot.getLoginErrMsg)

    this.sub = this.errMsg$.subscribe(_ =&gt; this.errMsg)

    this.loginSuccessful$ = store.select(fromRoot.getLoginSuccessful)
  }

  ngOnInit() {
  }

  public onSubmit() {
    this.store.dispatch(new auth.LoginAction({...this.user}))
  }

  ngOnDestroy() {
    this.sub.unsubscribe()
  }
}

</code></pre>

<p><img src="https://benetis.me/images/2017/05/error-response.gif" alt="" /></p>

<p>Response handled. If error - shows it above login form. We can adjust that to our needs in effect or reducer. We also indicate request is happening by showing <code>&lt;md-spinner&gt;</code></p>

<h4 id="saving-token">Saving token</h4>

<p>Starting with action to set access token. After we set access token we will need to update our state to have newest token + put in local storage so it can be grabbed later. State update will happen in reducer, as for LocalStorage update - it is a side effect so we will put it in effects.</p>

<pre><code class="language-typescript">export interface AuthInfo {
  access_token?: string,
  expires?: number,
  expires_in?: number
}

public static readonly tokenItem = 'token'

@Effect()
loginComplete$: Observable&lt;Action&gt; = this.actions$
  .ofType(auth.ActionTypes.LOGIN_COMPLETE)
  .map(toPayload)
  .switchMap((payload) =&gt; {

    if (payload) {
      const authInfoUpdated: AuthInfo = {
        ...payload,
        expires: payload.expires_in + Math.floor(Date.now() / 1000)
      }
      localStorage.setItem(AuthEffects.tokenItem, JSON.stringify(authInfoUpdated));
      return of(new auth.SetAuthInfoAction(authInfoUpdated))
    } else {
      return of(new auth.LogoutAction())
    }
  })
</code></pre>

<p><img src="https://benetis.me/images/2017/05/save-token.gif" alt="" /></p>

<h3 id="auth-guard">Auth guard</h3>

<p>Now that we have token saved in LocalStorage we can enable our AuthGuard. It will protect our routes and redirect unauthenticated user to login form.</p>

<pre><code class="language-typescript">@Injectable()
export class AuthGuard implements CanActivate {

  private loggedIn$: Observable&lt;boolean&gt;;

  constructor(private store: Store&lt;fromRoot.State&gt;
    , private router: Router) {

    this.loggedIn$ = store.select(fromRoot.getAuthLoggedIn)

  }

  canActivate(next: ActivatedRouteSnapshot, state: RouterStateSnapshot) {
    this.store.dispatch(new auth.LoginCompleteAction(
      JSON.parse(
        localStorage.getItem(AuthEffects.tokenItem)
      )
    ))

    return this.loggedIn$.map(loggedIn =&gt; {
      if (loggedIn) {
        return true;
      } else {
        this.router.navigate(['/login']);
      }
    }).catch((err) =&gt; {
      console.log(err)
      this.router.navigate(['/login']);
      return Observable.of(false);
    }).first()
  }
}
</code></pre>

<p>We subscribe to get if user is loggedIn (we set this state property to true when we set AuthInfo). Before that - we dispatch an action with our token from LocalStorage. We do this - so that user from email link or bookmark can directly access our application. Everything else is self explanatory.</p>

<p>p.s redirect url needs to be saved - I propose for you to dispatch action to save it and redirect later.</p>

<p><img src="https://benetis.me/images/2017/05/auth-guard.gif" alt="" /></p>

<h2 id="summary">Summary</h2>

<p>There are few more things we need to do for auth to be finished. Logout to clean redux state + LocalStorage items, refresh token and minor tweaks, updates.</p>

<h3 id="feedback">Feedback</h3>

<p>If you have any suggestions - I am eagerly waiting for feedback. <a href="https://benetis.me/post/contact-me/">https://benetis.me/post/contact-me/</a></p>

    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="https://benetis.me/">Žygimantas Benetis (Zygimantas Benetis)</a></h4>
  
  <p>Read <a href="https://benetis.me/">more posts</a> by this author.</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Kaunas, Lithuania</span>
    <span class="author-link icon-link"><a href="https://benetis.me">https://benetis.me</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Let%27s%20code%3a%20Authentication%20in%20Angular%20%232%20-%20Auth%20service&nbsp;-&nbsp;Typical%20personal%20blog&amp;url=https%3a%2f%2fbenetis.me%2fpost%2fangular-authentication-oauth%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fbenetis.me%2fpost%2fangular-authentication-oauth%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fbenetis.me%2fpost%2fangular-authentication-oauth%2f&amp;description=Let%27s%20code%3a%20Authentication%20in%20Angular%20%232%20-%20Auth%20service"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fbenetis.me%2fpost%2fangular-authentication-oauth%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Typical personal blog</a> All rights reserved - 2017</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://benetis.me/js/jquery.js"></script>
    <script type="text/javascript" src="https://benetis.me/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://benetis.me/js/index.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.6.0/prism.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.6.0/components/prism-typescript.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.6.0/components/prism-haskell.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.6.0/components/prism-javascript.min.js"></script>
    
</body>
</html>

